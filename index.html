<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Mood Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-frame">
    <!-- Top bar -->
    <div class="top-bar">
      <div class="top-bar-title">Study Mood Dashboard</div>
      <button class="menu-button" id="menuButton" aria-label="Menu">â˜°</button>
    </div>

    <!-- Home page -->
    <main id="homePage" class="page active">
      <!-- This Week card -->
      <section class="card" id="thisWeekCard">
        <h2>This Week</h2>

        <div class="summary-container">
          <div class="summary-box-left">
            <div class="summary-value" id="totalHours">0 hrs</div>
            <div class="summary-sub">Total study time (last 7 days)</div>
          </div>
          <div class="summary-box-right">
            <div class="summary-emoji-circle" id="avgMoodEmoji">ðŸ™‚</div>
            <div id="avgMoodLabel">No data yet</div>
          </div>
        </div>

        <div class="chart-area">
          <div class="chart-bars" id="chartBars"></div>
          <div class="week-mood-row" id="chartMoods"></div>
        </div>
      </section>

      <!-- Log Today card -->
      <section class="card">
        <h2>Log Today</h2>

        <form id="logForm">
          <div class="log-inner">
            <div class="log-label">Study Time (hrs)</div>
            <div class="log-moods">
              <input
                id="studyHoursInput"
                type="number"
                min="0"
                step="0.5"
                value="0"
                class="hours-input"
              />
              <div id="logMoodButtons"></div>
            </div>
          </div>
          <div class="log-helper">
            Mood is estimated from hours:
            0â€“&lt;2 = Very Bad,
            2â€“&lt;3 = Bad,
            3â€“&lt;4 = Medium,
            4â€“&lt;5 = Good,
            5+ = Very Good.
          </div>
          <button class="primary-btn" type="submit">Save Today's Log</button>
        </form>
      </section>

      <!-- Motivation card -->
      <section class="card">
        <h2>Today's Motivation</h2>
        <p class="motivation-text" id="motivationText">
          Small progress every day adds up.
        </p>
      </section>
    </main>

    <!-- History page -->
    <main id="historyPage" class="page">
      <section class="card history-card">
        <div class="history-header">
          <div class="history-title">History</div>
          <select id="rangeSelect" class="history-select">
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
          </select>
        </div>

        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Study Time (hrs)</th>
              <th>Mood</th>
            </tr>
          </thead>
          <tbody id="historyTableBody"></tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Side menu -->
  <div class="menu-overlay" id="menuOverlay">
    <div class="menu-panel">
      <button class="menu-close-btn" id="menuClose" aria-label="Close menu">âœ•</button>
      <nav class="menu-nav">
        <button class="menu-link" data-target="home">Home</button>
        <button class="menu-link" data-target="history">History</button>
      </nav>
    </div>
  </div>

  <script>
    const DATA_VERSION = "7";

    if (localStorage.getItem("studyLogsVersion") !== DATA_VERSION) {
      localStorage.removeItem("studyLogs");
      localStorage.setItem("studyLogsVersion", DATA_VERSION);
    }

    const MOODS = [
      { id: 1, emoji: "ðŸ˜£", label: "Very Bad",   color: "#ff6b6b" },
      { id: 2, emoji: "ðŸ˜•", label: "Bad",        color: "#ffb86b" },
      { id: 3, emoji: "ðŸ˜", label: "Medium",     color: "#ffe66b" },
      { id: 4, emoji: "ðŸ™‚", label: "Good",       color: "#c8ff6b" },
      { id: 5, emoji: "ðŸ˜„", label: "Very Good",  color: "#9cff57" }
    ];

    const motivationMessages = [
      "Small progress every day adds up.",
      "You do not have to study for long, just show up.",
      "Future you will thank you for studying today.",
      "Done is better than perfect.",
      "Focus for 25 minutes, then take a break."
    ];

    const MAX_HOURS_FOR_CHART = 8;

    function getTodayKey() {
      return new Date().toISOString().slice(0, 10);
    }

    function loadLogs() {
      return JSON.parse(localStorage.getItem("studyLogs") || "[]");
    }

    function saveLogs(logs) {
      localStorage.setItem("studyLogs", JSON.stringify(logs));
    }

    function computeStats(days = 7) {
      const logs = loadLogs();
      const today = new Date();
      const cutoff = new Date();
      cutoff.setDate(today.getDate() - (days - 1));

      const recent = logs.filter((log) => {
        const d = new Date(log.date);
        return d >= cutoff && d <= today;
      });

      const totalHours = recent.reduce((sum, log) => sum + log.hours, 0);
      const averageMoodValue =
        recent.length > 0
          ? recent.reduce((sum, log) => sum + log.moodId, 0) / recent.length
          : null;

      return { recent, totalHours, averageMoodValue };
    }

    function moodIdFromHours(hours) {
      if (hours >= 5) return 5;
      if (hours >= 4) return 4;
      if (hours >= 3) return 3;
      if (hours >= 2) return 2;
      if (hours > 0) return 1;
      return null;
    }

    function moodFromValue(value) {
      if (value == null) {
        return { emoji: "ðŸ™‚", label: "No data yet", color: "#e5e5ea" };
      }
      let id;
      if (value < 1.5) id = 1;
      else if (value < 2.5) id = 2;
      else if (value < 3.5) id = 3;
      else if (value < 4.5) id = 4;
      else id = 5;

      const mood = MOODS.find((m) => m.id === id) || MOODS[2];
      return mood;
    }

    const totalHoursEl = document.getElementById("totalHours");
    const avgMoodEmojiEl = document.getElementById("avgMoodEmoji");
    const avgMoodLabelEl = document.getElementById("avgMoodLabel");
    const chartBarsEl = document.getElementById("chartBars");
    const chartMoodsEl = document.getElementById("chartMoods");

    const logMoodButtons = document.getElementById("logMoodButtons");
    const logForm = document.getElementById("logForm");
    const hoursInput = document.getElementById("studyHoursInput");
    const motivationText = document.getElementById("motivationText");

    const rangeSelect = document.getElementById("rangeSelect");
    const historyTableBody = document.getElementById("historyTableBody");

    const homePage = document.getElementById("homePage");
    const historyPage = document.getElementById("historyPage");

    const menuButton = document.getElementById("menuButton");
    const menuOverlay = document.getElementById("menuOverlay");
    const menuClose = document.getElementById("menuClose");
    const menuLinks = document.querySelectorAll(".menu-link");

    let selectedMoodId = null;

    function showPage(page) {
      if (page === "history") {
        homePage.classList.remove("active");
        historyPage.classList.add("active");
      } else {
        historyPage.classList.remove("active");
        homePage.classList.add("active");
      }
      window.scrollTo(0, 0);
    }

    menuButton.addEventListener("click", () => {
      menuOverlay.classList.add("open");
    });

    menuClose.addEventListener("click", () => {
      menuOverlay.classList.remove("open");
    });

    menuOverlay.addEventListener("click", (e) => {
      if (e.target === menuOverlay) {
        menuOverlay.classList.remove("open");
      }
    });

    menuLinks.forEach((link) => {
      link.addEventListener("click", () => {
        const target = link.dataset.target;
        showPage(target);
        menuOverlay.classList.remove("open");
      });
    });

    function renderLogButtons() {
      logMoodButtons.innerHTML = "";
      MOODS.forEach((mood) => {
        const btn = document.createElement("div");
        btn.className = "log-mood-btn";
        btn.dataset.level = mood.id;
        btn.dataset.id = mood.id;
        btn.textContent = mood.emoji;
        btn.style.backgroundColor = mood.color;
        logMoodButtons.appendChild(btn);
      });
    }

    function updateLogButtonSelection() {
      const buttons = logMoodButtons.querySelectorAll(".log-mood-btn");
      buttons.forEach((btn) => {
        if (Number(btn.dataset.id) === selectedMoodId) {
          btn.classList.add("selected");
        } else {
          btn.classList.remove("selected");
        }
      });
    }

    hoursInput.addEventListener("input", () => {
      const hours = parseFloat(hoursInput.value) || 0;
      selectedMoodId = moodIdFromHours(hours);
      updateLogButtonSelection();
    });

    logForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const hours = parseFloat(hoursInput.value);
      if (isNaN(hours) || hours <= 0) {
        alert("Please enter how many hours you studied today.");
        return;
      }

      const moodId = moodIdFromHours(hours);
      selectedMoodId = moodId;
      updateLogButtonSelection();

      const todayKey = getTodayKey();
      let logs = loadLogs();

      const entry = {
        date: todayKey,
        hours: hours,
        moodId: moodId
      };

      const existingIndex = logs.findIndex((log) => log.date === todayKey);

      if (existingIndex >= 0) {
        logs[existingIndex] = entry;
      } else {
        logs.push(entry);
      }

      saveLogs(logs);
      renderAll();
      alert("Saved!");
    });

    function renderSummaryAndChart() {
      const { recent, totalHours, averageMoodValue } = computeStats(7);
      totalHoursEl.textContent = totalHours.toFixed(1) + " hrs";

      const moodInfo = moodFromValue(averageMoodValue);
      avgMoodEmojiEl.textContent = moodInfo.emoji;
      avgMoodEmojiEl.style.backgroundColor = moodInfo.color;
      avgMoodLabelEl.textContent =
        recent.length === 0 ? "No data yet" : moodInfo.label;

      chartBarsEl.innerHTML = "";
      chartMoodsEl.innerHTML = "";

            const days = [];
      const today = new Date();

      // Find Monday of the current week
      const weekday = today.getDay(); // 0=Sun,1=Mon,...,6=Sat
      const diffToMonday = (weekday + 6) % 7; // 0 if Mon, 1 if Tue, ...
      const monday = new Date(today);
      monday.setDate(today.getDate() - diffToMonday);

      for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        days.push(d);
      }

      const logs = loadLogs();
      const dayLabels = ["M", "T", "W", "T", "F", "S", "S"];

      days.forEach((dateObj, index) => {
        const key = dateObj.toISOString().slice(0, 10);
        const log = logs.find((l) => l.date === key);

        const wrap = document.createElement("div");
        wrap.className = "bar-wrapper";

        const bar = document.createElement("div");
        bar.className = "bar";

        // Make the bar height respond directly to hours (about 20px per hour)
        if (log && log.hours > 0) {
          const px = Math.min(log.hours * 20, 150); // cap so it stays inside chart
          bar.style.height = px + "px";
        } else {
          bar.style.height = "4px"; // tiny line when there is no data
        }

        const label = document.createElement("div");
        label.className = "day-label";
        label.textContent = dayLabels[index];

        wrap.appendChild(bar);
        wrap.appendChild(label);
        chartBarsEl.appendChild(wrap);

        const moodDot = document.createElement("div");
        moodDot.className = "mood-dot";
        if (log) {
          const mood = MOODS.find((m) => m.id === log.moodId);
          moodDot.textContent = mood ? mood.emoji : "ðŸ™‚";
        } else {
          moodDot.textContent = "Â·";
        }
        chartMoodsEl.appendChild(moodDot);
      });

      };

    function renderHistory() {
      const range = Number(rangeSelect.value);
      const { recent } = computeStats(range);

      const sorted = [...recent].sort((a, b) => (a.date < b.date ? 1 : -1));

      historyTableBody.innerHTML = "";
      sorted.forEach((log) => {
        const tr = document.createElement("tr");

        const d = new Date(log.date);
        const dateTd = document.createElement("td");
        dateTd.textContent = d.toLocaleDateString();

        const hoursTd = document.createElement("td");
        hoursTd.textContent = log.hours.toFixed(2);

        const moodTd = document.createElement("td");
        moodTd.className = "mood-cell";
        const mood = MOODS.find((m) => m.id === log.moodId);
        moodTd.textContent = mood ? mood.emoji : "ðŸ™‚";

        tr.appendChild(dateTd);
        tr.appendChild(hoursTd);
        tr.appendChild(moodTd);

        historyTableBody.appendChild(tr);
      });
    }

    rangeSelect.addEventListener("change", renderHistory);

    function fetchQuoteFromApi() {
      fetch("https://api.quotable.io/random")
        .then((res) => res.json())
        .then((data) => {
          if (data && data.content && data.author) {
            motivationText.textContent = data.content + " â€” " + data.author;
          } else {
            pickRandomMotivation();
          }
        })
        .catch(() => {
          pickRandomMotivation();
        });
    }

    function pickRandomMotivation() {
      const index = Math.floor(Math.random() * motivationMessages.length);
      motivationText.textContent = motivationMessages[index];
    }

    function renderAll() {
      renderSummaryAndChart();
      renderHistory();
      fetchQuoteFromApi();
    }

    renderLogButtons();
    renderAll();
  </script>
</body>
</html>
